{% extends "base.html" %}

{% block title %}Editar Ocorr√™ncia #{{ ocorrencia.id }}{% endblock %}

{% block content %}
<div class="card">
    <div class="card-header">
        <div class="d-flex justify-content-between align-items-center">
            <h1>Editar Ocorr√™ncia #{{ ocorrencia.id }}</h1>
            <div>
                <a href="{{ url_for('visualizar', id=ocorrencia.id) }}" class="btn btn-secondary">Visualizar</a>
                <a href="{{ url_for('index') }}" class="btn btn-secondary">Voltar</a>
            </div>
        </div>
    </div>
    <div class="card-body">
        <form method="POST" enctype="multipart/form-data">
            <!-- DADOS B√ÅSICOS DA OCORR√äNCIA -->
            <div class="section">
                <h2>1. Dados B√°sicos da Ocorr√™ncia</h2>
                
                <div class="form-group">
                    <label for="tipo">Tipo de Ocorr√™ncia <span class="required">*</span></label>
                    <select name="tipo" id="tipo" class="form-control" required>
                        <option value="">Selecione...</option>
                        <option value="Busca Terrestre" {% if ocorrencia.tipo == 'Busca Terrestre' %}selected{% endif %}>Busca Terrestre</option>
                        <option value="Busca Mar√≠tima" {% if ocorrencia.tipo == 'Busca Mar√≠tima' %}selected{% endif %}>Busca Mar√≠tima</option>
                    </select>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="data_fato">Data do Fato <span class="required">*</span></label>
                        <input type="date" name="data_fato" id="data_fato" class="form-control" value="{{ ocorrencia.data_fato or '' }}" required>
                    </div>
                    <div class="form-group">
                        <label for="data_acionamento">Data de Acionamento</label>
                        <input type="date" name="data_acionamento" id="data_acionamento" class="form-control" value="{{ ocorrencia.data_acionamento or '' }}">
                    </div>
                </div>

                <div class="form-group">
                    <label for="link">Link com Tracks do Google Earth</label>
                    <input type="url" name="link" id="link" class="form-control" value="{{ ocorrencia.link or '' }}" placeholder="https://...">
                </div>
            </div>

            <!-- DADOS DO LOCAL -->
            <div class="section">
                <h2>2. Dados do Local</h2>
                
                <div class="form-group">
                    <label for="endereco">Endere√ßo <span class="required">*</span></label>
                    <input type="text" name="endereco" id="endereco" class="form-control" value="{{ ocorrencia.endereco or '' }}" required placeholder="Rua, n√∫mero, bairro">
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="cidade">Cidade <span class="required">*</span></label>
                        <input type="text" name="cidade" id="cidade" class="form-control" value="{{ ocorrencia.cidade or '' }}" required>
                    </div>
                    <div class="form-group">
                        <label for="complemento">Complemento</label>
                        <input type="text" name="complemento" id="complemento" class="form-control" value="{{ ocorrencia.complemento or '' }}" placeholder="Ponto de refer√™ncia, detalhes">
                    </div>
                </div>

                <div class="form-group">
                    <label for="coordenada">Coordenadas</label>
                    <input type="text" name="coordenada" id="coordenada" class="form-control" value="{{ ocorrencia.coordenada or '' }}" placeholder="Latitude, Longitude">
                </div>
            </div>

            <!-- DADOS DA V√çTIMA -->
            <div class="section">
                <h2>3. Dados da V√≠tima</h2>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="nome_vitima">Nome da V√≠tima <span class="required">*</span></label>
                        <input type="text" name="nome_vitima" id="nome_vitima" class="form-control" value="{{ ocorrencia.nome_vitima or '' }}" required>
                    </div>
                    <div class="form-group">
                        <label for="cpf">CPF</label>
                        <input type="text" name="cpf" id="cpf" class="form-control" value="{{ ocorrencia.cpf or '' }}" placeholder="000.000.000-00">
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="sexo">Sexo <span class="required">*</span></label>
                        <select name="sexo" id="sexo" class="form-control" required>
                            <option value="">Selecione...</option>
                            <option value="Masculino" {% if ocorrencia.sexo == 'Masculino' %}selected{% endif %}>Masculino</option>
                            <option value="Feminino" {% if ocorrencia.sexo == 'Feminino' %}selected{% endif %}>Feminino</option>
                            <option value="N√£o informado" {% if ocorrencia.sexo == 'N√£o informado' %}selected{% endif %}>N√£o informado</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="idade">Idade</label>
                        <input type="text" name="idade" id="idade" class="form-control" value="{{ ocorrencia.idade or '' }}" placeholder="Ex: 25 anos">
                    </div>
                </div>

                <div class="form-group">
                    <label for="naturalidade">Naturalidade</label>
                    <input type="text" name="naturalidade" id="naturalidade" class="form-control" value="{{ ocorrencia.naturalidade or '' }}">
                </div>

                <div class="form-group">
                    <label for="filiacao">Filia√ß√£o</label>
                    <input type="text" name="filiacao" id="filiacao" class="form-control" value="{{ ocorrencia.filiacao or '' }}" placeholder="Nome dos pais">
                </div>

                <div class="form-group">
                    <label for="contatos">Contatos</label>
                    <input type="text" name="contatos" id="contatos" class="form-control" value="{{ ocorrencia.contatos or '' }}" placeholder="Telefone, email">
                </div>

                <div class="form-group">
                    <label for="enderecos">Endere√ßos</label>
                    <input type="text" name="enderecos" id="enderecos" class="form-control" value="{{ ocorrencia.enderecos or '' }}" placeholder="Endere√ßo residencial">
                </div>

                <div class="form-group">
                    <label for="vestimentas">Vestimentas</label>
                    <textarea name="vestimentas" id="vestimentas" class="form-control" placeholder="Descri√ß√£o das roupas que a v√≠tima estava usando">{{ ocorrencia.vestimentas or '' }}</textarea>
                </div>

                <div class="form-group">
                    <label for="caracteristicas_vitima">Caracter√≠sticas da V√≠tima</label>
                    <textarea name="caracteristicas_vitima" id="caracteristicas_vitima" class="form-control" placeholder="Altura, peso, cor dos olhos, cabelo, etc.">{{ ocorrencia.caracteristicas_vitima or '' }}</textarea>
                </div>

                <div class="form-group">
                    <label for="condicoes_neurologicas">Condi√ß√µes Neurol√≥gicas</label>
                    <textarea name="condicoes_neurologicas" id="condicoes_neurologicas" class="form-control" placeholder="Alzheimer, dem√™ncia, etc.">{{ ocorrencia.condicoes_neurologicas or '' }}</textarea>
                </div>

                <div class="form-group">
                    <label for="inf_medicas">Informa√ß√µes M√©dicas</label>
                    <textarea name="inf_medicas" id="inf_medicas" class="form-control" placeholder="Medicamentos, doen√ßas, etc.">{{ ocorrencia.inf_medicas or '' }}</textarea>
                </div>

                <div class="form-group">
                    <label for="experiencia_e_resistencia">Experi√™ncia e Resist√™ncia</label>
                    <textarea name="experiencia_e_resistencia" id="experiencia_e_resistencia" class="form-control" placeholder="Experi√™ncia com √°gua, nata√ß√£o, etc.">{{ ocorrencia.experiencia_e_resistencia or '' }}</textarea>
                </div>
            </div>

            <!-- CARACTER√çSTICAS DA √ÅREA DE BUSCA -->
            <div class="section">
                <h2>4. Caracter√≠sticas da √Årea de Busca</h2>
                
                <div class="form-group">
                    <label for="tipo_terreno_agua">Tipo de Terreno/√Ågua</label>
                    <select name="tipo_terreno_agua" id="tipo_terreno_agua" class="form-control">
                        <option value="">Selecione...</option>
                        <option value="Terrestre" {% if ocorrencia.tipo_terreno_agua == 'Terrestre' %}selected{% endif %}>Terrestre</option>
                        <option value="Mar" {% if ocorrencia.tipo_terreno_agua == 'Mar' %}selected{% endif %}>Mar</option>
                        <option value="Rio" {% if ocorrencia.tipo_terreno_agua == 'Rio' %}selected{% endif %}>Rio</option>
                        <option value="Lago" {% if ocorrencia.tipo_terreno_agua == 'Lago' %}selected{% endif %}>Lago</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="condicoes_do_tipo_terreno">Condi√ß√µes do Terreno</label>
                    <textarea name="condicoes_do_tipo_terreno" id="condicoes_do_tipo_terreno" class="form-control" placeholder="Profundidade, correnteza, vegeta√ß√£o, etc.">{{ ocorrencia.condicoes_do_tipo_terreno or '' }}</textarea>
                </div>

                <div class="form-group">
                    <label for="condicoes_climaticas">Condi√ß√µes Clim√°ticas</label>
                    <textarea name="condicoes_climaticas" id="condicoes_climaticas" class="form-control" placeholder="Temperatura, vento, chuva, visibilidade, etc.">{{ ocorrencia.condicoes_climaticas or '' }}</textarea>
                </div>
            </div>

            <!-- IMAGENS -->
            <div class="section">
                <h2>5. Imagens</h2>
                <p class="text-muted small">Marque as imagens que ser√£o utilizadas no relat√≥rio.</p>
                
                <div class="form-row">
                    <div class="form-group">
                        <div class="file-input">
                            <div class="d-flex align-items-center gap-2 mb-2">
                                <input type="checkbox" name="usa_img_condic_metereologica" id="usa_img_condic_metereologica" 
                                       {% if ocorrencia.usa_img_condic_metereologica %}checked{% endif %}>
                                <label for="usa_img_condic_metereologica" style="margin: 0;">Condi√ß√µes Meteorol√≥gicas</label>
                            </div>
                            <input type="file" name="img_condic_metereologica" id="img_condic_metereologica" accept="image/*">
                        </div>
                        {% if ocorrencia.img_condic_metereologica %}
                            <div class="mt-2">
                                <small class="text-muted">Imagem atual:</small><br>
                                <img src="{{ url_for('static', filename='uploads/' + ocorrencia.img_condic_metereologica.split('/')[-1]) }}" 
                                     alt="Condi√ß√µes Meteorol√≥gicas" style="max-width: 150px; height: auto;">
                            </div>
                        {% endif %}
                    </div>
                    <div class="form-group">
                        <div class="file-input">
                            <div class="d-flex align-items-center gap-2 mb-2">
                                <input type="checkbox" name="usa_img_local" id="usa_img_local" 
                                       {% if ocorrencia.usa_img_local %}checked{% endif %}>
                                <label for="usa_img_local" style="margin: 0;">Imagem do Local</label>
                            </div>
                            <input type="file" name="img_local" id="img_local" accept="image/*">
                        </div>
                        {% if ocorrencia.img_local %}
                            <div class="mt-2">
                                <small class="text-muted">Imagem atual:</small><br>
                                <img src="{{ url_for('static', filename='uploads/' + ocorrencia.img_local.split('/')[-1]) }}" 
                                     alt="Imagem do Local" style="max-width: 150px; height: auto;">
                            </div>
                        {% endif %}
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <div class="file-input">
                            <div class="d-flex align-items-center gap-2 mb-2">
                                <input type="checkbox" name="usa_img_upv" id="usa_img_upv" 
                                       {% if ocorrencia.usa_img_upv %}checked{% endif %}>
                                <label for="usa_img_upv" style="margin: 0;">Imagem do UPV</label>
                            </div>
                            <input type="file" name="img_upv" id="img_upv" accept="image/*">
                        </div>
                        {% if ocorrencia.img_upv %}
                            <div class="mt-2">
                                <small class="text-muted">Imagem atual:</small><br>
                                <img src="{{ url_for('static', filename='uploads/' + ocorrencia.img_upv.split('/')[-1]) }}" 
                                     alt="Imagem do UPV" style="max-width: 150px; height: auto;">
                            </div>
                        {% endif %}
                    </div>
                    <div class="form-group">
                        <div class="file-input">
                            <div class="d-flex align-items-center gap-2 mb-2">
                                <input type="checkbox" name="usa_img_satelite_upv" id="usa_img_satelite_upv" 
                                       {% if ocorrencia.usa_img_satelite_upv %}checked{% endif %}>
                                <label for="usa_img_satelite_upv" style="margin: 0;">Imagem de Sat√©lite UPV</label>
                            </div>
                            <input type="file" name="img_satelite_upv" id="img_satelite_upv" accept="image/*">
                        </div>
                        {% if ocorrencia.img_satelite_upv %}
                            <div class="mt-2">
                                <small class="text-muted">Imagem atual:</small><br>
                                <img src="{{ url_for('static', filename='uploads/' + ocorrencia.img_satelite_upv.split('/')[-1]) }}" 
                                     alt="Imagem de Sat√©lite UPV" style="max-width: 150px; height: auto;">
                            </div>
                        {% endif %}
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <div class="file-input">
                            <div class="d-flex align-items-center gap-2 mb-2">
                                <input type="checkbox" name="usa_img_raio_busca" id="usa_img_raio_busca" 
                                       {% if ocorrencia.usa_img_raio_busca %}checked{% endif %}>
                                <label for="usa_img_raio_busca" style="margin: 0;">Raio de Busca</label>
                            </div>
                            <input type="file" name="img_raio_busca" id="img_raio_busca" accept="image/*">
                        </div>
                        {% if ocorrencia.img_raio_busca %}
                            <div class="mt-2">
                                <small class="text-muted">Imagem atual:</small><br>
                                <img src="{{ url_for('static', filename='uploads/' + ocorrencia.img_raio_busca.split('/')[-1]) }}" 
                                     alt="Raio de Busca" style="max-width: 150px; height: auto;">
                            </div>
                        {% endif %}
                    </div>
                    <div class="form-group">
                        <div class="file-input">
                            <div class="d-flex align-items-center gap-2 mb-2">
                                <input type="checkbox" name="usa_img_tab_mare" id="usa_img_tab_mare" 
                                       {% if ocorrencia.usa_img_tab_mare %}checked{% endif %}>
                                <label for="usa_img_tab_mare" style="margin: 0;">T√°bua de Mar√©</label>
                            </div>
                            <input type="file" name="img_tab_mare" id="img_tab_mare" accept="image/*">
                        </div>
                        {% if ocorrencia.img_tab_mare %}
                            <div class="mt-2">
                                <small class="text-muted">Imagem atual:</small><br>
                                <img src="{{ url_for('static', filename='uploads/' + ocorrencia.img_tab_mare.split('/')[-1]) }}" 
                                     alt="T√°bua de Mar√©" style="max-width: 150px; height: auto;">
                            </div>
                        {% endif %}
                    </div>
                </div>

                <div class="form-group">
                    <div class="file-input">
                        <div class="d-flex align-items-center gap-2 mb-2">
                            <input type="checkbox" name="usa_img_prev_temp_onda" id="usa_img_prev_temp_onda" 
                                   {% if ocorrencia.usa_img_prev_temp_onda %}checked{% endif %}>
                            <label for="usa_img_prev_temp_onda" style="margin: 0;">Previs√£o de Temperatura e Ondas</label>
                        </div>
                        <input type="file" name="img_prev_temp_onda" id="img_prev_temp_onda" accept="image/*">
                    </div>
                    {% if ocorrencia.img_prev_temp_onda %}
                        <div class="mt-2">
                            <small class="text-muted">Imagem atual:</small><br>
                            <img src="{{ url_for('static', filename='uploads/' + ocorrencia.img_prev_temp_onda.split('/')[-1]) }}" 
                                 alt="Previs√£o de Temperatura e Ondas" style="max-width: 150px; height: auto;">
                        </div>
                    {% endif %}
                </div>
            </div>

            <!-- IMAGENS CUSTOMIZADAS -->
            <div class="section">
                <h2>6. Imagens Adicionais (Customizadas)</h2>
                <p class="text-muted small">Gerencie imagens com descri√ß√µes personalizadas.</p>
                
                <!-- Imagens customizadas existentes -->
                {% if imagens_customizadas %}
                    {% for img_custom in imagens_customizadas %}
                    <div class="custom-image-item mb-3 p-3 border rounded">
                        <div class="d-flex justify-content-between align-items-start mb-2">
                            <h6 class="mb-0">Imagem: {{ img_custom.titulo }}</h6>
                            <div class="form-check">
                                <input type="checkbox" class="form-check-input" name="custom_delete_{{ img_custom.id }}" id="custom_delete_{{ img_custom.id }}">
                                <label class="form-check-label text-danger" for="custom_delete_{{ img_custom.id }}">Excluir</label>
                            </div>
                        </div>
                        <div class="form-group mb-2">
                            <label for="custom_titulo_existente_{{ img_custom.id }}">T√≠tulo/Descri√ß√£o</label>
                            <input type="text" name="custom_titulo_existente_{{ img_custom.id }}" 
                                   id="custom_titulo_existente_{{ img_custom.id }}" 
                                   class="form-control" value="{{ img_custom.titulo }}" required>
                        </div>
                        <div class="form-group mb-2">
                            <div class="d-flex align-items-center gap-2 mb-2">
                                <input type="checkbox" name="custom_usa_existente_{{ img_custom.id }}" 
                                       id="custom_usa_existente_{{ img_custom.id }}" 
                                       {% if img_custom.usa_imagem %}checked{% endif %}>
                                <label for="custom_usa_existente_{{ img_custom.id }}" style="margin: 0;">Usar esta imagem no relat√≥rio</label>
                            </div>
                            <label for="custom_imagem_existente_{{ img_custom.id }}">Alterar imagem (deixe em branco para manter a atual)</label>
                            <input type="file" name="custom_imagem_existente_{{ img_custom.id }}" 
                                   id="custom_imagem_existente_{{ img_custom.id }}" 
                                   class="form-control" accept="image/*">
                            {% if img_custom.caminho %}
                                <div class="mt-2">
                                    <small class="text-muted">Imagem atual:</small><br>
                                    <img src="{{ url_for('static', filename='uploads/' + img_custom.caminho.split('/')[-1]) }}" 
                                         alt="{{ img_custom.titulo }}" style="max-width: 150px; height: auto;">
                                </div>
                            {% endif %}
                        </div>
                    </div>
                    {% endfor %}
                {% endif %}
                
                <!-- Container para novas imagens customizadas -->
                <div id="custom-images-container">
                    <!-- Novas imagens customizadas ser√£o adicionadas aqui via JavaScript -->
                </div>
                
                <button type="button" id="add-custom-image-btn" class="btn btn-outline-primary btn-sm mt-2">
                    ‚ûï Adicionar Nova Imagem Customizada
                </button>
            </div>

            <!-- HIST√ìRICO DA OCORR√äNCIA -->
            <div class="section">
                <h2>7. Hist√≥rico da Ocorr√™ncia</h2>
                
                <div class="form-group">
                    <label for="historico_ocorrencia">Hist√≥rico Detalhado <span class="required">*</span></label>
                    <textarea name="historico_ocorrencia" id="historico_ocorrencia" class="form-control" rows="6" required placeholder="Descreva detalhadamente como ocorreu o fato, circunst√¢ncias, testemunhas, etc.">{{ ocorrencia.historico_ocorrencia or '' }}</textarea>
                </div>
            </div>

            <div class="text-center">
                <button type="submit" class="btn btn-success">Salvar Altera√ß√µes</button>
                <a href="{{ url_for('visualizar', id=ocorrencia.id) }}" class="btn btn-secondary">Cancelar</a>
            </div>
        </form>
    </div>
</div>

<script>
let customImageIndex = 0;

document.addEventListener('DOMContentLoaded', function() {
    const tipoOcorrencia = document.getElementById('tipo');
    const tipoTerreno = document.getElementById('tipo_terreno_agua');
    
    // Fun√ß√£o para atualizar o tipo de terreno
    function atualizarTipoTerreno() {
        if (tipoOcorrencia.value === 'Busca Terrestre') {
            tipoTerreno.value = 'Terrestre';
            tipoTerreno.disabled = true;
        } else if (tipoOcorrencia.value === 'Busca Mar√≠tima') {
            tipoTerreno.disabled = false;
        } else {
            tipoTerreno.disabled = false;
        }
    }
    
    // Aplicar na carga inicial
    atualizarTipoTerreno();
    
    // Aplicar quando o tipo de ocorr√™ncia mudar
    tipoOcorrencia.addEventListener('change', atualizarTipoTerreno);

    // Sistema de imagens customizadas
    const container = document.getElementById('custom-images-container');
    const addBtn = document.getElementById('add-custom-image-btn');

    function addCustomImageField() {
        const index = customImageIndex++;
        const div = document.createElement('div');
        div.className = 'custom-image-item mb-3 p-3 border rounded';
        div.setAttribute('data-index', index);
        
        div.innerHTML = `
            <div class="d-flex justify-content-between align-items-start mb-2">
                <h6 class="mb-0">Nova Imagem Customizada #${index + 1}</h6>
                <button type="button" class="btn btn-sm btn-danger remove-custom-image" data-index="${index}">
                    üóëÔ∏è Remover
                </button>
            </div>
            <div class="form-group mb-2">
                <label for="custom_titulo_${index}">T√≠tulo/Descri√ß√£o da Imagem <span class="required">*</span></label>
                <input type="text" name="custom_titulo_${index}" id="custom_titulo_${index}" 
                       class="form-control" required placeholder="Ex: Mapa de correntes, Foto a√©rea, etc.">
            </div>
            <div class="form-group mb-2">
                <div class="d-flex align-items-center gap-2 mb-2">
                    <input type="checkbox" name="custom_usa_${index}" id="custom_usa_${index}" checked>
                    <label for="custom_usa_${index}" style="margin: 0;">Usar esta imagem no relat√≥rio</label>
                </div>
                <input type="file" name="custom_imagem_${index}" id="custom_imagem_${index}" 
                       class="form-control" accept="image/*" required>
            </div>
        `;
        
        container.appendChild(div);
        
        // Adiciona evento de remo√ß√£o
        div.querySelector('.remove-custom-image').addEventListener('click', function() {
            div.remove();
        });
    }

    if (addBtn) {
        addBtn.addEventListener('click', addCustomImageField);
    }
});
</script>
{% endblock %}
